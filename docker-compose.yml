services:
  solr:
    container_name: sdoh-solr
    image: 'solr:9.7.0-slim'
    user: root
    ports:
    - 8983:8983
    environment:
      - SOLR_CORE_STAGE=${SOLR_CORE_STAGE:-blacklight-core-stage}
      - SOLR_CORE_PROD=${SOLR_CORE_PROD:-blacklight-core-prod}
    healthcheck:
      test: ["CMD-SHELL", "bin/solr status"]
      interval: 10s
      retries: 5
      start_period: 120s
      timeout: 10s
    volumes:
      - ./solr/web.xml:/opt/solr-9.7.0-slim/server/solr-webapp/webapp/WEB-INF/web.xml
      - ./solr/solr.in.sh:/etc/default/solr.in.sh
      - ./solr:/solr-configset
      - ./solr-data:/var/solr/data
    command: 
      - 'bash'
      - '-c'
      - |
        # Create directories for both cores dynamically (as root)
        mkdir -p /var/solr/data/$SOLR_CORE_STAGE/data
        mkdir -p /var/solr/data/$SOLR_CORE_PROD/data
        mkdir -p /var/solr/logs
        chown -R solr:solr /var/solr/data
        chown -R solr:solr /var/solr/logs
        
        # Copy configset files to core directories
        cp -r /solr-configset/* /var/solr/data/$SOLR_CORE_STAGE/
        cp -r /solr-configset/* /var/solr/data/$SOLR_CORE_PROD/
        chown -R solr:solr /var/solr/data
        
        # Start Solr as solr user
        exec su solr -c "
          # Start Solr in background
          /opt/solr/bin/solr start -f &
          SOLR_PID=\$!
          
          # Wait for Solr to be ready
          echo 'Waiting for Solr to start...'
          until curl -s http://localhost:8983/solr/admin/cores?action=STATUS >/dev/null 2>&1; do
            sleep 2
          done
          
          # Create staging core
          echo 'Creating staging core...'
          /opt/solr/bin/solr create_core -c $SOLR_CORE_STAGE
          
          # Create production core
          echo 'Creating production core...'
          /opt/solr/bin/solr create_core -c $SOLR_CORE_PROD
          
          # Wait for the background Solr process
          wait \$SOLR_PID
        "

  manager:
    container_name: sdoh-manager
    image: herop/sdoh-metadata-manager
    build:
      context: .
    depends_on:
      solr:
        condition: service_healthy
        restart: true
    env_file: .env
    environment:
      - PYTHONPATH=/home/herop
    working_dir: /home/herop
    volumes:
      - ./manager:/home/herop/manager
    ports:
    - 8000:8000
