services:
  solr:
    container_name: sdoh-solr
    image: 'solr:9.7.0-slim'
    ports:
    - 8983:8983
    healthcheck:
      test: ["CMD-SHELL", "bin/solr status"]
      interval: 10s
      retries: 5
      start_period: 120s
      timeout: 10s
    volumes:
      - ./solr/web.xml:/opt/solr-9.7.0-slim/server/solr-webapp/webapp/WEB-INF/web.xml
      - ./solr/solr.in.sh:/etc/default/solr.in.sh
      - ./solr:/solr-configset
      - ./solr/init-cores.sh:/docker-entrypoint-initdb.d/init-cores.sh
    command: 
      - 'bash'
      - '-c'
      - |
        # Create dev core and start Solr in background
        solr-precreate blacklight-core-dev /solr-configset &
        SOLR_PID=$!
        
        # Wait for Solr to be ready
        echo "Waiting for Solr to start..."
        until curl -s http://localhost:8983/solr/admin/cores?action=STATUS > /dev/null 2>&1; do
          sleep 2
        done
        
        # Create production core
        echo "Creating production core..."
        solr create_core -c blacklight-core-prod -d /solr-configset
        
        # Wait for the background Solr process
        wait $SOLR_PID

  manager:
    container_name: sdoh-manager
    image: herop/sdoh-metadata-manager
    build:
      context: .
    depends_on:
      solr:
        condition: service_healthy
        restart: true
    env_file: .env.docker
    volumes:
      - ./manager:/home/herop/manager
    ports:
    - 8000:8000
