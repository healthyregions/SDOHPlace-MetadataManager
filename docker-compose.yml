services:
  traefik:
    container_name: sdoh-traefik
    image: traefik:v3.0
    restart: unless-stopped
    command:
      - --api.dashboard=true
      - --api.insecure=false
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - letsencrypt:/letsencrypt
    labels:
      - "traefik.enable=true"
      # HTTP router with redirect to HTTPS
      - "traefik.http.routers.traefik-dashboard-http.rule=Host(`traefik.${DOMAIN_NAME}`)"
      - "traefik.http.routers.traefik-dashboard-http.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard-http.middlewares=redirect-to-https"
      # HTTPS router for dashboard API
      - "traefik.http.routers.traefik-api.rule=Host(`traefik.${DOMAIN_NAME}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.traefik-api.entrypoints=websecure"
      - "traefik.http.routers.traefik-api.tls=true"
      - "traefik.http.routers.traefik-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-api.service=api@internal"
      # HTTPS router for dashboard UI
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${DOMAIN_NAME}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=dashboard@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-auth@docker"
      # Basic auth middleware for dashboard
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_AUTH}"

  solr:
    container_name: sdoh-solr
    image: 'solr:9.7.0-slim'
    user: root
    restart: unless-stopped
    # Expose via Traefik; no direct host port
    environment:
      - SOLR_CORE_STAGE=${SOLR_CORE_STAGE:-blacklight-core-stage}
      - SOLR_CORE_PROD=${SOLR_CORE_PROD:-blacklight-core-prod}
    healthcheck:
      test: ["CMD-SHELL", "bin/solr status"]
      interval: 10s
      retries: 5
      start_period: 120s
      timeout: 10s
    volumes:
      - ./solr/web.xml:/opt/solr-9.7.0-slim/server/solr-webapp/webapp/WEB-INF/web.xml
      - ./solr/solr.in.sh:/etc/default/solr.in.sh
      - ./solr:/solr-configset
      - ./solr-data:/var/solr/data
    command: 
      - 'bash'
      - '-c'
      - |
        # Create directories for both cores dynamically (as root)
        mkdir -p /var/solr/data/$SOLR_CORE_STAGE/data
        mkdir -p /var/solr/data/$SOLR_CORE_PROD/data
        mkdir -p /var/solr/logs
        chown -R solr:solr /var/solr/data
        chown -R solr:solr /var/solr/logs
        
        # Copy configset files to core directories
        cp -r /solr-configset/* /var/solr/data/$SOLR_CORE_STAGE/
        cp -r /solr-configset/* /var/solr/data/$SOLR_CORE_PROD/
        chown -R solr:solr /var/solr/data
        
        # Start Solr as solr user
        exec su solr -c "
          # Start Solr in background
          /opt/solr/bin/solr start -f &
          SOLR_PID=\$!
          
          # Wait for Solr to be ready
          echo 'Waiting for Solr to start...'
          until curl -s http://localhost:8983/solr/admin/cores?action=STATUS >/dev/null 2>&1; do
            sleep 2
          done
          
          # Create staging core
          echo 'Creating staging core...'
          /opt/solr/bin/solr create_core -c $SOLR_CORE_STAGE
          
          # Create production core
          echo 'Creating production core...'
          /opt/solr/bin/solr create_core -c $SOLR_CORE_PROD
          
          # Wait for the background Solr process
          wait \$SOLR_PID
        "
    labels:
      - "traefik.enable=true"
      # HTTP router (redirect to HTTPS) for solr subdomain
      - "traefik.http.middlewares.solr-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.solr-http.rule=Host(`solr.${DOMAIN_NAME}`)"
      - "traefik.http.routers.solr-http.entrypoints=web"
      - "traefik.http.routers.solr-http.middlewares=solr-redirect"
      # HTTPS router for Solr admin UI
      - "traefik.http.routers.solr-https.rule=Host(`solr.${DOMAIN_NAME}`)"
      - "traefik.http.routers.solr-https.entrypoints=websecure"
      - "traefik.http.routers.solr-https.tls=true"
      - "traefik.http.routers.solr-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.solr-https.middlewares=solr-auth@docker"
      - "traefik.http.services.solr-svc.loadbalancer.server.port=8983"
      - "traefik.http.routers.solr-https.service=solr-svc"
      # Basic auth middleware for Solr
      - "traefik.http.middlewares.solr-auth.basicauth.users=${SOLR_AUTH}"

  manager:
    container_name: sdoh-manager
    image: herop/sdoh-metadata-manager
    build:
      context: .
    restart: unless-stopped
    user: root
    depends_on:
      solr:
        condition: service_healthy
        restart: true
    env_file: .env
    environment:
      - PYTHONPATH=/home/herop
    working_dir: /home/herop
    volumes:
      - ./manager:/home/herop/manager
    expose:
    - 8000
    command: |
      sh -lc "
        chown -R herop:herop /home/herop/manager || true
        
        # Start Flask in background
        su -s /bin/sh -c 'PATH=/home/herop/.local/bin:$PATH flask run -h 0.0.0.0 -p 8000' herop &
        FLASK_PID=\$!
        
        # Wait for Flask to be ready
        echo 'Waiting for Flask to start...'
        until curl -s http://localhost:8000/ >/dev/null 2>&1; do
          sleep 2
        done
        echo 'Flask is ready!'
        
        # Create default admin user (ignore error if already exists)
        su -s /bin/sh -c 'PATH=/home/herop/.local/bin:$PATH flask user create ${ADMIN_USERNAME:-admin} ${ADMIN_EMAIL:-admin@example.com} ${ADMIN_PASSWORD:-changeme}' herop 2>/dev/null || echo 'Admin user already exists or could not be created'
        
        # Index all records to stage core
        echo 'Indexing records to stage core...'
        su -s /bin/sh -c 'PATH=/home/herop/.local/bin:$PATH flask registry index --env stage' herop
        
        # Index all records to prod core
        echo 'Indexing records to prod core...'
        su -s /bin/sh -c 'PATH=/home/herop/.local/bin:$PATH flask registry index --env prod' herop
        
        echo 'Initialization complete!'
        
        # Wait for Flask process to keep container alive
        wait \$FLASK_PID
      "
    labels:
      - "traefik.enable=true"
      # HTTP router with redirect to HTTPS
      - "traefik.http.routers.sdoh-manager.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.sdoh-manager.entrypoints=web"
      - "traefik.http.routers.sdoh-manager.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      # HTTPS router
      - "traefik.http.routers.sdoh-manager-secure.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.sdoh-manager-secure.entrypoints=websecure"
      - "traefik.http.routers.sdoh-manager-secure.tls=true"
      - "traefik.http.routers.sdoh-manager-secure.tls.certresolver=letsencrypt"
      # Service points to container's internal port
      - "traefik.http.services.sdoh-manager.loadbalancer.server.port=8000"

volumes:
  letsencrypt:
