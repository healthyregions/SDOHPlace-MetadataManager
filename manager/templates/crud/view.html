{% extends 'base.html' %}

{% block page_title %}{{ record.title }}{% endblock %}

{% block sidebar %}
<h2 class="subtitle">Actions</h2>
{% if user.is_authenticated %}
<div class="buttons are-small has-addons">
    <a href="{{ url_for('manager.handle_record', id=record.id) }}?edit=true" class="button" role="button">Edit</a>
</div>
<h2 class="subtitle">Index to Solr</h2>
<div class="field is-grouped is-grouped-vertical">
    <div class="control">
        <button class="button is-info is-small index-btn"
                data-env="stage"
                data-core="{{ solr.core_stage }}"
                data-record-id="{{ record.id }}"
                title="Index to stage core ({{ solr.core_stage }})">
            Index — Stage
        </button>
    </div>
    {% if user.name == "admin" %}
    <div class="control">
        <button class="button is-warning is-small index-btn"
                data-env="prod"
                data-core="{{ solr.core_prod }}"
                data-record-id="{{ record.id }}"
                title="Index to production core ({{ solr.core_prod }}) - Admin only">
            Index — Prod
        </button>
    </div>
    {% else %}
    <div class="control">
        <button class="button is-warning is-small" disabled title="Only admin users can index to production">
            Index — Prod (admin only)
        </button>
    </div>
    {% endif %}
</div>

<!-- Confirmation Modal -->
<div id="index-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Confirm Indexing</p>
            <button class="delete" aria-label="close" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <p><strong>Record:</strong> <span id="modal-record-title"></span></p>
            <p id="modal-message">Are you sure you want to index this record?</p>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" id="confirm-index">Yes, Index</button>
            <button class="button" onclick="closeModal()">Cancel</button>
        </footer>
    </div>
</div>

<style>
.field.is-grouped-vertical {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
    gap: 0;
}

.field.is-grouped-vertical .control {
    margin: 0 !important;
    width: auto;
    display: block;
}

.field.is-grouped-vertical .control:last-child {
    margin: 0 !important;
}

.field.is-grouped-vertical .control .button {
    margin: 0 !important;
    width: auto;
    min-width: 120px;
    border-radius: 0;
}

.field.is-grouped-vertical .control:first-child .button {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}

.field.is-grouped-vertical .control:last-child .button {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}
</style>

<script>
let currentIndexData = null;

// Add click handlers to index buttons
document.addEventListener('DOMContentLoaded', function() {
    const indexButtons = document.querySelectorAll('.index-btn');
    indexButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const env = this.dataset.env;
            const core = this.dataset.core;
            const recordId = this.dataset.recordId;
            
            currentIndexData = {
                env: env,
                core: core,
                recordId: recordId,
                button: this
            };
            
            // Update modal content
            const modalRecordTitle = document.getElementById('modal-record-title');
            const modalMessage = document.getElementById('modal-message');
            
            // Get the record title from the page title
            const recordTitle = document.title || 'Unknown Record';
            modalRecordTitle.textContent = recordTitle;
            modalMessage.textContent = `Are you sure you want to index this record to the ${env} environment (${core})?`;
            
            // Show modal
            document.getElementById('index-modal').classList.add('is-active');
        });
    });
    
    // Handle confirm button click
    document.getElementById('confirm-index').addEventListener('click', function() {
        if (currentIndexData) {
            // Perform the actual indexing
            const url = "{{ url_for('manager.handle_solr', id='PLACEHOLDER') }}".replace('PLACEHOLDER', currentIndexData.recordId) + '?env=' + currentIndexData.env;
            
            // Use htmx to make the request
            htmx.ajax('POST', url, {
                target: '#reindex-result',
                swap: 'innerHTML'
            });
            
            closeModal();
        }
    });
});

function closeModal() {
    document.getElementById('index-modal').classList.remove('is-active');
    currentIndexData = null;
}

// Close modal when clicking background
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-background')) {
        closeModal();
    }
});
</script>
{% else %}
<p><em>You are not logged in.</em></p>
{% endif %}
<h2 class="subtitle">View record as...</h2>
<div class="buttons are-small has-addons">
    <a href="{{ url_for('manager.handle_record', id=record.id) }}?f=json" class="button">JSON</a>
    <a href="{{ url_for('manager.handle_record', id=record.id) }}?f=solr" class="button">Solr</a>
</div>
<h2 class="subtitle">View record in...</h2>
<div class="buttons are-small has-addons">
    <a href="{{ discovery_app_url }}/search/?show={{ record.id }}" class="button" role="button" target="_blank">Data Discovery App</a>
</div>
<div id="reindex-result"></div>
<h2 class="subtitle">Jump to</h2>
<div class="content" style="height:100%">
    <ul style="font-size:.8em; list-style:none; margin-left:0">
        {% for link in link_list %}
        <li><a href="/record/{{link.id}}">{{link.title}}</a></li>
        {% endfor %}
    </ul>
</div>
{% endblock %}

{% block main_content %}
<div class="tabs is-toggle is-small">
    <ul>
        {% for group in display_groups %}
        <li><a href="#{{ group['name'] }}">{{ group['name'] }}</a></li>
        {% endfor %}
    </ul>
</div>
<div class="record-content">
    {% for group in display_groups %}
    <section>
        <h2 id="{{ group['name'] }}" class="subtitle">{{ group['name'] }}</h2>
        <table class="table table-striped is-fullwidth">
            <tbody style="overflow-x:auto;">
                {% for field in group['fields'] %}
                <tr class="display-group">
                    <td scope="row" style="width:250px;">
                        <span class="{{ field.obligation }} form-label">
                            {{ field.label }}
                            {% if field.multiple %}+{% endif %}
                        </span>
                        {% if field.schema == 'Aardvark' %}
                            <a href="https://opengeometadata.org/ogm-aardvark/#{{ field.slug }}" target="_blank">&nearr;</a>
                        {% endif %}
                    </td>
                    <td>
                    {% if field['id'] == "keyword" and record[field['id']] %}
                        {% for keyword in record[field['id']] %}
                        <span class="tag">{{ keyword }}</span>
                        {% endfor %}
                    {% else %}
                        {% if field['data_type'] != "boolean" and record[field['id']] and record[field['id']]|length > 100 %}
                        <details>
                            <summary>show full (this value is very long)</summary>
                            {{ record[field['id']] }}
                        </details>
                        {% else %}
                        {{ record[field['id']] }}
                        {% endif %}
                    {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endfor %}
</div>
{% endblock %}
